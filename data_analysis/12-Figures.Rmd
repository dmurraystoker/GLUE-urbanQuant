---
title: "GLUE-urbanQuant"
subtitle: "ESA 2022 Subproject: Figures"
author: "David Murray-Stoker"
output:
  pdf_document:
    toc: true
    toc_depth: 4
    fig_caption: yes
    latex_engine: xelatex
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(results = "hold", fig.pos = "H", fig.align = "center", out.width = "92.5%")
options(knitr.graphics.error = FALSE)
kableExtra::usepackage_latex("float")
```

```{r Load Package for R Markdown, include = FALSE}
library(kableExtra)
library(knitr)
```

```{r Load Packages & Data, echo = TRUE, results = "hide"}
## Load the tidyverse
library(tidyverse)

## Packages for data extraction and management (Points & Transects)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(sp)

## Packages for figures
library(ggeffects)
library(ggmap, quietly = TRUE)
library(ggpubr)
library(ggspatial)
library(scales)
library(viridis)

## Load data
# Sites and environmental data
final.data <- read_csv(
	file = "ESA_2022_subproject/data/analysis_data/final_data-ESA.csv",
	#col_types = c("ffffnnnnnnnnnnnnnnn"), # With NDVI
	col_types = c("ffffnnnnnnnnnnnn"), # Without NDVI
	show_col_types = FALSE
	)

## Load deviation LMMs
# City area
City.Area.deviation.LMM.list <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/city_area_deviation_LMMs.rds"
	)
# Human population size
Human.Population.Size.deviation.LMM.list <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/human_population_size_deviation_LMMs.rds"
	)

## Reorder Sample Type levels for plotting
final.data$Sample_Type <- fct_relevel(
	final.data$Sample_Type,
	c("GLUE", "Random_Transect", "Random_Points", "Systematic_Points")
	)
```

```{r Set Colour Palette, include = FALSE}
## Points & Transects------------------------------------------------------
## Set base palettes from which colours will be selected
plasma.continuous <- plasma(n = 16)

## View the base palettes
show_col(plasma.continuous)

## Set colours
sampled.points.col    <- plasma.continuous[7]
random.points.col     <- plasma.continuous[1]
systematic.points.col <- plasma.continuous[1]
random.transect.col   <- plasma.continuous[1]
city.center.col       <- plasma.continuous[14]


## Sample Type-------------------------------------------------------------
## Generate a base palette
plasma.continuous  <- plasma(n = 12)

## View the colour palette
show_col(plasma.continuous)

## Set the final palette
sample.type.plasma.pal <- plasma.continuous[c(1, 4, 8, 11)]
```





\newpage
# Site Map

```{r}
city.data <- read_csv(
	file = "ESA_2022_subproject/data/ESA_city_coordinates.csv",
	col_types = c("fffnn"),
	show_col_types = FALSE
	)

city.data.sf <- st_as_sf(
	city.data,
	coords = c("City_Longitude", "City_Latitude"),
	crs = 4326,
	agr = "constant"
	)

world <- ne_countries(scale = "medium", returnclass = "sf")

site.map <- ggplot(data = world) +
	geom_sf(color = "black", fill = "antiquewhite") +
	geom_sf(data = city.data.sf, size = 7.5, shape = 19, fill = "darkgoldenrod1") +
  annotation_north_arrow(
  	location = "bl", which_north = "true",
  	pad_x = unit(0.75, "in"), pad_y = unit(1.5, "in"),
  	style = north_arrow_fancy_orienteering
  	) +
	theme(panel.background = element_rect(fill = "aliceblue")) +
	rremove(c("xylab"))

ggsave("fig_0-ESA_city_map-base.pdf", 
			 plot = site.map, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 15, 
			 height = 10,
			 units = "in", 
			 dpi = 600)
```





\newpage
# Points & Transects

```{r LLoad the GLUE Transect Data, echo = TRUE}
## Load sampled transect
sampled.transect.df <- read_csv(
	"ESA_2022_subproject/data/sampled_transects/Montreal.csv",
	col_types = c("fffnninnn"),
	show_col_types = FALSE
	)
```


## GLUE & Random Transects

```{r Set the GLUE Transect Figure, echo = TRUE}
## Load random transect
random.transect.df <- read_csv(
	"ESA_2022_subproject/data/filtered_random_transects/Montreal_filtered_random_transect.csv",
	col_types = c("fffnn"),
	show_col_types = FALSE
	)

## Set the boundary box
# Height and width of the boundary box
height <- max(random.transect.df$Latitude) - min(random.transect.df$Latitude)
width  <- max(random.transect.df$Longitude) - min(random.transect.df$Longitude)

# Add buffer around the boundary box
boundary_box <- c(
	left   = min(random.transect.df$Longitude) - (2 * width),
	bottom = min(random.transect.df$Latitude) - (0.25 * height),
	right  = max(random.transect.df$Longitude) + (0.25 * width),
	top    = max(random.transect.df$Latitude) + (0.75 * height)
	)

## Prepare data for spatial plotting
# Specify columns with coordinates
coordinates(random.transect.df) <- ~Longitude + Latitude

# Set CRS
proj4string(random.transect.df) <- CRS("+init=epsg:4326")

# Convert df to sf
random.transect.sf <- random.transect.df %>%
	st_as_sf(coords = c("Longitude", "Latitude")) %>%
	st_transform(crs = 4326)

# Transect map
transect.map <- get_stamenmap(
	bbox = boundary_box,
	zoom = 10,
	maptype = "terrain-background",
	source = "stamen"
	) %>%
	ggmap() +
	geom_sf(
		data = random.transect.sf,
		color = random.transect.col,
		alpha = 0.75,
		size = 3,
		inherit.aes = FALSE
	) +
	geom_point(
		data = sampled.transect.df,
		aes(x = Population_Longitude, y = Population_Latitude),
		color = sampled.points.col,
		size = 3
	) + 
	geom_point(
		data = sampled.transect.df,
		aes(x = City_Longitude, y = City_Latitude),
		color = city.center.col,
		size = 7.5,
		shape = 18
	) +
	labs(title = "Montreal: GLUE & Random Transects",
			 x = "Longitude",
			 y = "Latitude") +
	theme_pubr()
```

\vspace{10pt}

```{r Save the GLUE Transect Figure, include = FALSE}
## Export the figure
ggsave("fig_0.1-GLUE_random_transect.pdf", 
			 plot = transect.map, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 6, 
			 height = 8,
			 units = "in", 
			 dpi = 600)
```


\newpage
## Random Points

```{r Set the Random Points Figure, echo = TRUE}
## Load random points
random.points.df <- read_csv(
	"ESA_2022_subproject/data/filtered_random_points/Montreal_filtered_random_points.csv",
  col_types = c("fffnn"),
	show_col_types = FALSE
	)

## Set the boundary box
# Height and width of the boundary box
height <- max(random.points.df$Latitude) - min(random.points.df$Latitude)
width  <- max(random.points.df$Longitude) - min(random.points.df$Longitude)

# Add buffer around the boundary box
boundary_box <- c(
	left   = min(random.points.df$Longitude) - (0.15 * width),
	bottom = min(random.points.df$Latitude) - (0.15 * height),
	right  = max(random.points.df$Longitude) + (0.15 * width),
	top    = max(random.points.df$Latitude) + (0.15 * height)
	)

## Prepare data for spatial plotting
# Specify columns with coordinates
coordinates(random.points.df) <- ~Longitude + Latitude

# Set CRS
proj4string(random.points.df) <- CRS("+init=epsg:4326")

# Convert df to sf
random.points.sf <- random.points.df %>%
	st_as_sf(coords = c("Longitude", "Latitude")) %>%
	st_transform(crs = 4326)

# Random points map
random.points.map <- get_stamenmap(
	bbox = boundary_box,
	zoom = 10,
	maptype = "terrain-background",
	source = "stamen"
	) %>%
	ggmap() +
	geom_sf(
		data = random.points.sf,
		color = random.points.col,
		alpha = 0.75,
		size = 3,
		inherit.aes = FALSE
		) +
	geom_point(
		data = sampled.transect.df,
		aes(x = City_Longitude, y = City_Latitude),
		color = city.center.col,
		size = 7.5,
		shape = 18
		) +
	labs(title = "Montreal: Random Points",
			 x = "Longitude",
			 y = "Latitude") +
	theme_pubr()
```

\vspace{10pt}

```{r Save the Random Points Figure, include = FALSE}
## Export the figure
ggsave("fig_0.2-random_points.pdf", 
			 plot = random.points.map, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 6, 
			 height = 8,
			 units = "in", 
			 dpi = 600)
```



\newpage
## Systematic Points

```{r Set the Systematic Points Figure, echo = TRUE}
## Load systematic points
systematic.points.df <- read_csv(
	"ESA_2022_subproject/data/filtered_systematic_points/Montreal_filtered_systematic_points.csv",
	col_types = c("ffnn"),
	show_col_types = FALSE
	)

## Set the boundary box
# Height and width of the boundary box
height <- max(systematic.points.df$Latitude) - min(systematic.points.df$Latitude)
width  <- max(systematic.points.df$Longitude) - min(systematic.points.df$Longitude)

# Add buffer around the boundary box
boundary_box <- c(
	left   = min(systematic.points.df$Longitude) - (0.15 * width),
	bottom = min(systematic.points.df$Latitude) - (0.15 * height),
	right  = max(systematic.points.df$Longitude) + (0.15 * width),
	top    = max(systematic.points.df$Latitude) + (0.15 * height)
	)

## Prepare data for spatial plotting
# Specify columns with coordinates
coordinates(systematic.points.df) <- ~Longitude + Latitude

# Set CRS
proj4string(systematic.points.df) <- CRS("+init=epsg:4326")

# Convert df to sf
systematic.points.sf <- systematic.points.df %>%
	st_as_sf(coords = c("Longitude", "Latitude")) %>%
	st_transform(crs = 4326)

# Systematic points map
systematic.points.map <- get_stamenmap(
	bbox = boundary_box,
	zoom = 10,
	maptype = "terrain-background",
	source = "stamen"
	) %>%
	ggmap() +
	geom_sf(
		data = systematic.points.sf,
		color = systematic.points.col,
		alpha = 0.75,
		size = 3,
		inherit.aes = FALSE
		) +
	geom_point(
		data = sampled.transect.df,
		aes(x = City_Longitude, y = City_Latitude),
		color = city.center.col,
		size = 7.5,
		shape = 18
		) +
	labs(title = "Montreal: Systematic Points",
			 x = "Longitude",
			 y = "Latitude") +
	theme_pubr()
```

\vspace{10pt}

```{r Save the Systematic Points Figure, include = FALSE}
## Export the figure
ggsave("fig_0.3-systematic_points.pdf", 
			 plot = systematic.points.map, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 6, 
			 height = 8,
			 units = "in", 
			 dpi = 600)
```





\newpage
# Question 1 Figures

\vspace{10pt}

## ANOVAs

```{r Urbanization Metric ANOVA Figures, echo = TRUE}
## Set the figures
# Distance
Distance.ANOVA.figure <- ggerrorplot(
	data = final.data,
	x = "Sample_Type",
	y = "Distance",
	desc_stat = "mean_se",
	size = 2.25, 
	width = 1.75,
	color = "Sample_Type",
	xlab = "Sample Type",
	ylab = "Distance from the City Center (km)",
	title = "Distance by Sample Type",
	palette = sample.type.plasma.pal,
	ggtheme = theme_pubr(),
	legend = "none"
	) +
	rotate_x_text(angle = 20) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")

# GMIS
GMIS.ANOVA.figure <- ggerrorplot(
	data = final.data,
	x = "Sample_Type",
	y = "GMIS_Mean",
	desc_stat = "mean_se",
	size = 2.25, 
	width = 1.75,
	color = "Sample_Type",
	xlab = "Sample Type",
	ylab = "Impervious Surface Cover (%)",
	title = "ISC by Sample Type",
	palette = sample.type.plasma.pal,
	ggtheme = theme_pubr(),
	legend = "none"
	) +
	rotate_x_text(angle = 20) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")

# Mean annual temperature
Mean.Annual.Temperature.ANOVA.figure <- ggerrorplot(
	data = final.data,
	x = "Sample_Type",
	y = "Mean_Annual_Temperature",
	desc_stat = "mean_se",
	size = 2.25, 
	width = 1.75,
	color = "Sample_Type",
	xlab = "Sample Type",
	ylab = "Mean Annual Temperature (C)",
	title = "MAT by Sample Type",
	palette = sample.type.plasma.pal,
	ggtheme = theme_pubr(),
	legend = "none"
	) +
	rotate_x_text(angle = 20) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")
```

\vspace{10pt}

```{r Save the Urbanization Metric ANOVA Figures, include = FALSE}
## Export the figures
# Distance
ggsave("fig_1a-Distance_ANOVA-base.pdf", 
			 plot = Distance.ANOVA.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)

# GMIS
ggsave("fig_1b-GMIS_ANOVA-base.pdf", 
			 plot = GMIS.ANOVA.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)

# Mean annual temperature
ggsave("fig_1c-Temperature_ANOVA-base.pdf", 
			 plot = Mean.Annual.Temperature.ANOVA.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)
```





\newpage
## Linear Mixed-Effects Models

```{r Set the Urbanization Metric LMM Figures, echo = TRUE}
## Set the figures
# GMIS
GMIS.LMM.figure <- ggplot(
	data = final.data,
	aes(x = Standardized_Distance, y = GMIS_Mean, colour = Sample_Type)
	) +
	geom_smooth(
		aes(fill = Sample_Type),
		method = "lm", formula = y ~ x, se = TRUE, size = 1.5) +
	labs(x = "Standardized Distance", y = "Impervious Surface Cover (%)") +
	scale_colour_manual(values = sample.type.plasma.pal) +
	scale_fill_manual(values = sample.type.plasma.pal) +
	theme_pubr() +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")

# Mean annual temperature
Mean.Annual.Temperature.LMM.figure <- ggplot(
	data = final.data,
	aes(x = Standardized_Distance, y = Mean_Annual_Temperature, colour = Sample_Type)
	) +
	geom_smooth(
		aes(fill = Sample_Type),
		method = "lm", formula = y ~ x, se = TRUE, size = 1.5) +
	labs(x = "Standardized Distance", y = "Mean Annual Temperature (C)") +
	scale_colour_manual(values = sample.type.plasma.pal) +
	scale_fill_manual(values = sample.type.plasma.pal) +
	theme_pubr() +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")
```

\vspace{10pt}

```{r Save the Urbanization Metric LMM Figures, include = FALSE}
## Export the figures
# GMIS
ggsave("fig_2a-GMIS_LMM-base.pdf", 
			 plot = GMIS.LMM.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)

# Mean annual temperature
ggsave("fig_2b-Temperature_LMM-base.pdf", 
			 plot = Mean.Annual.Temperature.LMM.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)
```





\newpage
# Question 2 Figures

\vspace{10pt}

## Deviation Linear Mixed-Effects Models

### GMIS

```{r GMIS Deviation Data Management, echo = TRUE}
## Set the ggpredict objects for the GMIS deviation LMMs
GMIS.by.city.area.deviation.data <- ggpredict(
	City.Area.deviation.LMM.list$GMIS,
	terms = c("Predictor_Variable", "Sample_Type")
	)
GMIS.by.human.population.size.deviation.data <- ggpredict(
	Human.Population.Size.deviation.LMM.list$GMIS,
	terms = c("Predictor_Variable", "Sample_Type")
	)

## Set group as a factor
GMIS.by.city.area.deviation.data$group <- as_factor(
	GMIS.by.city.area.deviation.data$group
	)
GMIS.by.human.population.size.deviation.data$group <- as_factor(
	GMIS.by.human.population.size.deviation.data$group
	)

## Relevel factors
GMIS.by.city.area.deviation.data$group <- fct_relevel(
	GMIS.by.city.area.deviation.data$group,
	c("GLUE", "Random_Transect", "Random_Points", "Systematic_Points")
	)
GMIS.by.human.population.size.deviation.data$group <- fct_relevel(
	GMIS.by.human.population.size.deviation.data$group,
	c("GLUE", "Random_Transect", "Random_Points", "Systematic_Points")
	)
```

\vspace{10pt}

```{r Set the GMIS Deviation LMM Plots, echo = TRUE}
## Set the figures
# City area
GMIS.by.city.area.figure <- plot(
	GMIS.by.human.population.size.deviation.data,
	colors = sample.type.plasma.pal
	) +
	geom_smooth(
		aes(fill = group),
		method = "lm", formula = y ~ x, se = TRUE, size = 1.5
		) +
  labs(x = "City Area (km2)", y = "Predicted Change \n Impervious Surface Cover (Slope)") +
  theme_pubr() +
	ggtitle(NULL) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")

# Human population size
GMIS.by.human.population.size.figure <- plot(
	GMIS.by.human.population.size.deviation.data,
	colors = sample.type.plasma.pal
	) +
	geom_smooth(
		aes(fill = group),
		method = "lm", formula = y ~ x, se = TRUE, size = 1.5
		) +
  labs(x = "Human Population Size (no.)", y = "Predicted Change \n Impervious Surface Cover (Slope)") +
  theme_pubr() +
	ggtitle(NULL) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")
```

\vspace{10pt}

```{r Save the GMIS Deviation Figure, include = FALSE}
## Export the figures
# City area
ggsave("fig_3a-GMIS_City_Area_Deviation-base.pdf", 
			 plot = GMIS.by.city.area.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)

# Human population size
ggsave("fig_3b-GMIS_Human_Population_Size_Deviation-base.pdf", 
			 plot = GMIS.by.human.population.size.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)
```



\newpage
### Mean Annual Temperature

```{r Mean Annual Temperature Deviation Data Management, echo = TRUE}
## Set the ggpredict objects for the mean annual temperature deviation LMMs
mean.annual.temperature.by.city.area.deviation.data <- ggpredict(
	City.Area.deviation.LMM.list$Mean_Annual_Temperature,
	terms = c("Predictor_Variable", "Sample_Type")
	)
mean.annual.temperature.by.human.population.size.deviation.data <- ggpredict(
	Human.Population.Size.deviation.LMM.list$Mean_Annual_Temperature,
	terms = c("Predictor_Variable", "Sample_Type")
	)

## Set group as a factor
mean.annual.temperature.by.city.area.deviation.data$group <- as_factor(
	mean.annual.temperature.by.city.area.deviation.data$group
	)
mean.annual.temperature.by.human.population.size.deviation.data$group <- as_factor(
	mean.annual.temperature.by.human.population.size.deviation.data$group
	)

## Relevel factors
mean.annual.temperature.by.city.area.deviation.data$group <- fct_relevel(
	mean.annual.temperature.by.city.area.deviation.data$group,
	c("GLUE", "Random_Transect", "Random_Points", "Systematic_Points")
	)
mean.annual.temperature.by.human.population.size.deviation.data$group <- fct_relevel(
	mean.annual.temperature.by.human.population.size.deviation.data$group,
	c("GLUE", "Random_Transect", "Random_Points", "Systematic_Points")
	)
```

\vspace{10pt}

```{r Set the Mean Annual Temperature Deviation LMM Figures, echo = TRUE}
## Set the figures
# City area
mean.annual.temperature.by.city.area.figure <- plot(
	mean.annual.temperature.by.human.population.size.deviation.data,
	colors = sample.type.plasma.pal
	) +
	geom_smooth(
		aes(fill = group),
		method = "lm", formula = y ~ x, se = TRUE, size = 1.5
		) +
  labs(x = "City Area (km2)", y = "Predicted Change \n Mean Annual Temperature (Slope)") +
  theme_pubr() +
	ggtitle(NULL) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")

# Human population size
mean.annual.temperature.by.human.population.size.figure <- plot(
	mean.annual.temperature.by.human.population.size.deviation.data,
	colors = sample.type.plasma.pal
	) +
	geom_smooth(
		aes(fill = group),
		method = "lm", formula = y ~ x, se = TRUE, size = 1.5
		) +
  labs(x = "Human Population Size (no.)", y = "Predicted Change \n Mean Annual Temperature (Slope)") +
  theme_pubr() +
	ggtitle(NULL) +
	font("xlab", size = 16, color = "gray0") +
	font("ylab", size = 16, color = "gray0") +
	font("xy.text", size = 12, color = "gray20")
```

\vspace{10pt}

```{r Save the Mean Annual Temperature Deviation Figures, include = FALSE}
## Export the figures
# City area
ggsave("fig_4a-Temperature_City_Area_Deviation-base.pdf", 
			 plot = mean.annual.temperature.by.city.area.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)

# Human population size
ggsave("fig_4b-Temperature_Human_population_Size_Deviation-base.pdf", 
			 plot = mean.annual.temperature.by.human.population.size.figure, 
			 device = "pdf",
			 path = "ESA_2022_subproject/figures/",
			 width = 8, 
			 height = 6,
			 units = "in", 
			 dpi = 600)
```










\newpage
# R Session Information

```{r R Packages, echo = FALSE}
df_session_packages <- devtools::session_info()$packages %>% 
  as.data.frame(.) %>% 
  filter(attached == TRUE) %>% 
  dplyr::select(loadedversion, date) %>% 
  rownames_to_column

colnames(df_session_packages) <- c("Package", "Loaded Version", "Date")

kable(
  df_session_packages, 
  booktabs = TRUE,
  caption = "Packages required for data management and figure creation."
  ) %>%
	kable_styling(
		full_width = FALSE,
  	latex_options = c("HOLD_position", "striped")
  	) 
```





