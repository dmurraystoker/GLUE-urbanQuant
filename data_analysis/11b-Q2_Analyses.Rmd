---
title: "GLUE-urbanQuant"
subtitle: "ESA 2022 Subproject: Analyses (Q2)"
author: "David Murray-Stoker"
output:
  pdf_document:
    toc: true
    toc_depth: 4
    fig_caption: yes
    latex_engine: xelatex
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(results = "hold", fig.pos = "H", fig.align = "center", out.width = "92.5%")
options(knitr.graphics.error = FALSE)
kableExtra::usepackage_latex("float")
```

```{r Load Packages for R Markdown, include = FALSE}
library(kableExtra)
library(knitr)
```

```{r Load Packages & Data, include = FALSE}
## Load the tidyverse
library(tidyverse)

## Packages for analyses
library(broom)
library(car)
library(easystats)
library(ggeffects)
library(lme4)
library(lmerTest)
```


\newpage
# Load Data

Description goes here...


```{r Load Data, echo = TRUE}
## Load data
# Urbanization metric LMMs
GMIS.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/GMIS_LMM.rds"
	)
HII.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/HII_LMM.rds"
	)
Mean.Annual.Temperature.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/mean_annual_temperature_LMM.rds"
	)
Temperature.Seasonality.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/temperature_seasonality_LMM.rds"
	)
Range.Annual.Temperature.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/range_annual_temperature_LMM.rds"
	)
Annual.Precipitation.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/annual_precipitation_LMM.rds"
	)
Precipitation.Seasonality.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/precipitation_seasonality_LMM.rds"
	)
Aridity.Index.LMM <- read_rds(
	file = "ESA_2022_subproject/data/analysis_data/aridity_index_LMM.rds"
	)

# City data
city.data <- read_csv(
	file = "ESA_2022_subproject/data/analysis_data/city_information-ESA.csv",
	col_types = c("fffnnnnnii"),
	show_col_types = FALSE
	)

## Function to center and scale predictor variables
center_and_scale <- function(x){
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
	}
```





\newpage
# Deviation Data

Description goes here...


```{r Set extract_deviation_data Function, echo = TRUE}
#' Description goes here...
#' 
#' 

## Set the function
extract_deviation_data <- function(fitted_model, city_data) {
	
	## Get predictions from the linear mixed-effects model (LMM)
	LMM.predictions <- ggpredict(
		model = fitted_model,
		terms = c("Standardized_Distance", "Sample_Type", "City"),
		type = "random"
		) %>%
	as_tibble() %>%
	rename(Standardized_Distance = x, Predicted = predicted,
				 Sample_Type = group, City = facet)
	
	## Get the full slope along the gradient (i.e., not binned predictions)
	# Predicted value at distance = 0
	urban.prediction <- LMM.predictions %>%
		group_by(City) %>%
		filter(Standardized_Distance == 0) %>%
		pull(Predicted)
	# Predicted value at distance = 1
	rural.prediction <- LMM.predictions %>%
		group_by(City) %>%
		filter(Standardized_Distance == 1) %>%
		pull(Predicted)
	# Calculate the rate of change along the urbanization gradient (slope)
	predicted.change <- rural.prediction - urban.prediction
	
	## Combine the slope data with sample type and city for analysis
	deviation.data <- tibble(
		Slope = predicted.change,
		City = rep(levels(city_data$City), times = 4),
		Sample_Type = rep(c("GLUE", "Random_Points", "Systematic_Points", "Random_Transect"), each = 12)
		) %>%
		full_join(city_data, by = "City") %>%
		select(Continent, Country, City, Sample_Type, Slope, City_Latitude:Number_Nearby_Cities) %>%
		# Center and scale all variables
		mutate(Slope = center_and_scale(Slope),
					 City_Area = center_and_scale(City_Area),
				   Human_Population_Size = center_and_scale(Human_Population_Size),
				   Human_Population_Density = center_and_scale(Human_Population_Density),
				   City_Age = center_and_scale(City_Age),
				   Number_Nearby_Cities = center_and_scale(Number_Nearby_Cities)
				 )
	
	}
```

\vspace{10pt}

```{r Deviation Data Management, echo = TRUE}
## Set the model list
LMM.list <- list(GMIS.LMM, HII.LMM, Mean.Annual.Temperature.LMM, Temperature.Seasonality.LMM,
								 Range.Annual.Temperature.LMM, Annual.Precipitation.LMM,
								 Precipitation.Seasonality.LMM, Aridity.Index.LMM)

## Get a list of deviation data in separate dataframes
deviation.data <- map_dfr(
	LMM.list, extract_deviation_data,
	city_data = city.data
	)

## Add predictor variables identifier to the data
deviation.data$Predictor <- rep(
	c("GMIS", "HII", "Mean_Annual_Temperature", "Temperature_Seasonality",
		"Range_Annual_Temperature", "Annual_Precipitation", "Precipitation_Seasonality",
		"Aridity_Index"),
	each = 48
	)

## Split deviation data into list by predictor variable
deviation.data.list <- deviation.data %>%
	group_split(Predictor)

## Set names for each dataframe in the deviation data list
names(deviation.data.list) <- c(
	"Annual_Precipitation", "Aridity_Index", "GMIS", "HII", "Mean_Annual_Temperature",
	"Precipitation_Seasonality", "Range_Annual_Temperature", "Temperature_Seasonality"
	)
```





\newpage
# Predictors of Deviations

Description goes here...

Linear mixed-effects model

Extract slopes using ggpredicts 
- One slope for each sample type for each city (4 slopes/city)
- Use city information to identify predictors of deviations
  + E.g., city area, age, humyn population size


\newpage
## Set Functions

```{r fit_deviation_LMM Function, echo = TRUE}
#' Description goes here...
#' 
#' 

## Set the function
fit_deviation_LMM <- function(df, predictor_variable) {
	
	# Set the predictor variable
  Predictor_Variable <- df %>% pull(predictor_variable)
	
	## Fit the linear mixed-effects model
	fitted.LMM <- lmer(
		Slope ~ Predictor_Variable * Sample_Type + (1 | City),
		data = df,
		REML = TRUE,
		control = lmerControl(optCtrl = list(maxfun = 100000))
		)
	
	}
```

\vspace{10pt}

```{r deviation_LMM_ANOVA Function, echo = TRUE}
#' Description goes here...
#' 
#' 

## Set the function
deviation_LMM_ANOVA <- function(fitted_model) {
	
	# ANOVA with Type III sums-of-squares
	LMM.anova.table <- anova(
		object = fitted_model,
		type = "III",
		ddf = "Kenward-Roger"
		)
	
	return(LMM.anova.table)
	
}
```

\newpage

```{r deviation_LMM_effect_sizes Function, echo = TRUE}
#' Description goes here...
#' 
#' 

## Set the function
deviation_LMM_effect_sizes <- function(fitted_model) {
	
	# Get the marginal and conditional R-squared
	LMM.R.squared.values <- MuMIn::r.squaredGLMM(fitted_model)
	
	# Effect sizes for the fixed effects
	LMM.eta.squared <- eta_squared(fitted_model, partial = TRUE, ci = 0.95)
	
	# Combine the effect sizes into a summary dataframe
	LMM.effect.size.summary.table <- tibble(
		R2_Marginal = LMM.R.squared.values[1],
		R2_Condition = LMM.R.squared.values[2],
		eta2_Predictor = LMM.eta.squared[1, 2],
		eta2_Sample_Type = LMM.eta.squared[2, 2],
		eta2_Interaction = LMM.eta.squared[3, 2]
		)
	
	return(LMM.effect.size.summary.table)
	
	}
```

\vspace{10pt}

```{r deviation_LMM_predictions Function, echo = TRUE}
#' Description goes here...
#' 
#' 

## Set the function
deviation_LMM_predictions <- function(fitted_model) {
	
	# Get the predictions from the fitted LMM
	LMM.predictions <- ggpredict(
		model = fitted_model,
		terms = c("Predictor_Variable", "Sample_Type"),
		type = "random"
		) %>%
	as_tibble() %>%
	rename(predictor_variable = x, Predicted = predicted,
				 SE = std.error, CI_lower = conf.low, CI_upper = conf.high,
				 Sample_Type = group)
	
	return(LMM.predictions)
	
	}
```



\newpage
## City Area

```{r City Area LMMs & Results, echo = TRUE}
## Fit the LMMs
City.Area.deviation.LMM.list <- map(
	deviation.data.list,
	fit_deviation_LMM,
	predictor_variable = "City_Area"
	)

## ANOVA
City.Area.ANOVAs <- map(
	City.Area.deviation.LMM.list,
	deviation_LMM_ANOVA
	)

## Effect sizes
City.Area.effect.sizes <- map_dfr(
	City.Area.deviation.LMM.list,
	deviation_LMM_effect_sizes
	)

## Predictions
City.Area.predictions <- map(
	City.Area.deviation.LMM.list,
	deviation_LMM_predictions
	)
```



\newpage
## City Age

```{r City Age LMMs & Results, echo = TRUE}
## Fit the LMMs
City.Age.deviation.LMM.list <- map(
	deviation.data.list,
	fit_deviation_LMM,
	predictor_variable = "City_Age"
	)

## ANOVA
City.Age.ANOVAs <- map(
	City.Age.deviation.LMM.list,
	deviation_LMM_ANOVA
	)

## Effect sizes
City.Age.effect.sizes <- map_dfr(
	City.Age.deviation.LMM.list,
	deviation_LMM_effect_sizes
	)

## Predictions
City.Age.predictions <- map(
	City.Age.deviation.LMM.list,
	deviation_LMM_predictions
	)
```



\newpage
## Human Population Size

```{r Human Population Size LMMs & Results, echo = TRUE}
## Fit the LMMs
Human.Population.Size.deviation.LMM.list <- map(
	deviation.data.list,
	fit_deviation_LMM,
	predictor_variable = "Human_Population_Size"
	)

## ANOVA
Human.Population.Size.ANOVAs <- map(
	Human.Population.Size.deviation.LMM.list,
	deviation_LMM_ANOVA
	)

## Effect sizes
Human.Population.Size.effect.sizes <- map_dfr(
	Human.Population.Size.deviation.LMM.list,
	deviation_LMM_effect_sizes
	)

## Predictions
Human.Population.Size.predictions <- map(
	Human.Population.Size.deviation.LMM.list,
	deviation_LMM_predictions
	)
```



\newpage
## Human Population Density

```{r Human Populaton Density LMMs & Results, echo = TRUE}
## Fit the LMMs
Human.Population.Density.deviation.LMM.list <- map(
	deviation.data.list,
	fit_deviation_LMM,
	predictor_variable = "Human_Population_Density"
	)

## ANOVA
Human.Population.Density.ANOVAs <- map(
	Human.Population.Density.deviation.LMM.list,
	deviation_LMM_ANOVA
	)

## Effect sizes
Human.Population.Density.effect.sizes <- map_dfr(
	Human.Population.Density.deviation.LMM.list,
	deviation_LMM_effect_sizes
	)

## Predictions
Human.Population.Density.predictions <- map(
	Human.Population.Density.deviation.LMM.list,
	deviation_LMM_predictions
	)
```



\newpage
## Number of Nearby Cities

```{r Number of Nearby Cities LMMs & Results, echo = TRUE}
## Fit the LMMs
Number.Nearby.Cities.deviation.LMM.list <- map(
	deviation.data.list,
	fit_deviation_LMM,
	predictor_variable = "Number_Nearby_Cities"
	)

## ANOVA
Number.Nearby.Cities.ANOVAs <- map(
	Number.Nearby.Cities.deviation.LMM.list,
	deviation_LMM_ANOVA
	)

## Effect sizes
Number.Nearby.Cities.effect.sizes <- map_dfr(
	Number.Nearby.Cities.deviation.LMM.list,
	deviation_LMM_effect_sizes
	)

## Predictions
Number.Nearby.Cities.predictions <- map(
	Number.Nearby.Cities.deviation.LMM.list,
	deviation_LMM_predictions
	)
```





\newpage
# Export Data

```{r Export Data for Figures, echo = TRUE}
## Main data
write_rds(
	deviation.data,
	file = "ESA_2022_subproject/data/analysis_data/deviation_data.rds"
	)

## Results from deviation LMMs
# City area
write_rds(
	City.Area.deviation.LMM.list,
	file = "ESA_2022_subproject/data/analysis_data/city_area_deviation_LMMs.rds"
	)
write_rds(
	City.Area.ANOVAs,
	file = "ESA_2022_subproject/data/analysis_data/city_area_ANOVAs.rds"
	)
write_rds(
	City.Area.effect.sizes,
	file = "ESA_2022_subproject/data/analysis_data/city_area_effect_sizes.rds"
	)
write_rds(
	City.Area.predictions,
	file = "ESA_2022_subproject/data/analysis_data/city_area_predictions.rds"
	)

# City age
write_rds(
	City.Age.deviation.LMM.list,
	file = "ESA_2022_subproject/data/analysis_data/city_age_deviation_LMMs.rds"
	)
write_rds(
	City.Age.ANOVAs,
	file = "ESA_2022_subproject/data/analysis_data/city_age_ANOVAs.rds"
	)
write_rds(
	City.Age.effect.sizes,
	file = "ESA_2022_subproject/data/analysis_data/city_age_effect_sizes.rds"
	)
write_rds(
	City.Age.predictions,
	file = "ESA_2022_subproject/data/analysis_data/city_age_predictions.rds"
	)

# Human population size
write_rds(
	Human.Population.Size.deviation.LMM.list,
	file = "ESA_2022_subproject/data/analysis_data/human_population_size_deviation_LMMs.rds"
	)
write_rds(
	Human.Population.Size.ANOVAs,
	file = "ESA_2022_subproject/data/analysis_data/human_population_size_ANOVAs.rds"
	)
write_rds(
	Human.Population.Size.effect.sizes,
	file = "ESA_2022_subproject/data/analysis_data/human_population_size_effect_sizes.rds"
	)
write_rds(
	Human.Population.Size.predictions,
	file = "ESA_2022_subproject/data/analysis_data/human_population_size_predictions.rds"
	)

# Human population density
write_rds(
	Human.Population.Density.deviation.LMM.list,
	file = "ESA_2022_subproject/data/analysis_data/human_population_density_deviation_LMMs.rds"
	)
write_rds(
	Human.Population.Density.ANOVAs,
	file = "ESA_2022_subproject/data/analysis_data/human_population_density_ANOVAs.rds"
	)
write_rds(
	Human.Population.Density.effect.sizes,
	file = "ESA_2022_subproject/data/analysis_data/human_population_density_effect_sizes.rds"
	)
write_rds(
	Human.Population.Density.predictions,
	file = "ESA_2022_subproject/data/analysis_data/human_population_density_predictions.rds"
	)

# Number nearby cities
write_rds(
	Number.Nearby.Cities.deviation.LMM.list,
	file = "ESA_2022_subproject/data/analysis_data/number_nearby_cities_deviation_LMMs.rds"
	)
write_rds(
	Number.Nearby.Cities.ANOVAs,
	file = "ESA_2022_subproject/data/analysis_data/number_nearby_cities_ANOVAs.rds"
	)
write_rds(
	Number.Nearby.Cities.effect.sizes,
	file = "ESA_2022_subproject/data/analysis_data/number_nearby_cities_effect_sizes.rds"
	)
write_rds(
	Number.Nearby.Cities.predictions,
	file = "ESA_2022_subproject/data/analysis_data/number_nearby_cities_predictions.rds"
	)
```








```{r Save the Workspace, include = FALSE}
## Save the workspace
save.image("ESA_2022_subproject/data_analysis/10b-Q2_analyses-workspace.RData")
```





\newpage
# Workspace Information

```{r R Packages, echo = FALSE}
df_session_packages <- devtools::session_info()$packages %>% 
  as.data.frame(.) %>% 
  filter(attached == TRUE) %>% 
  dplyr::select(loadedversion, date) %>% 
  rownames_to_column

colnames(df_session_packages) <- c("Package", "Loaded Version", "Date")

kable(
  df_session_packages, 
  booktabs = TRUE,
  caption = "Packages required for data management and analyses."
  ) %>%
	kable_styling(
		full_width = FALSE,
  	latex_options = c("HOLD_position", "striped")
  	) 
```




